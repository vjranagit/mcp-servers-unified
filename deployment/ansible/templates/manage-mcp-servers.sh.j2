#!/bin/bash

# MCP Servers Management Script
# Manages comprehensive MCP server deployment for Software House & Real Estate LLC

set -euo pipefail

# Configuration
MCP_BASE_DIR="{{ mcp_servers_base_dir }}"
MCP_LOG_DIR="{{ mcp_log_dir }}"
MCP_CONFIG_DIR="{{ mcp_config_dir }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Server categories and names
declare -A SERVERS=(
{% for server_name, server_config in mcp_servers.items() %}
    ["{{ server_name }}"]="{{ server_config.category }}"
{% endfor %}
)

# Helper functions
show_usage() {
    cat << EOF
MCP Servers Management Script

Usage: $0 [COMMAND] [OPTIONS]

Commands:
    start [SERVER|CATEGORY]     Start MCP server(s)
    stop [SERVER|CATEGORY]      Stop MCP server(s)
    restart [SERVER|CATEGORY]   Restart MCP server(s)
    status [SERVER|CATEGORY]    Show status of MCP server(s)
    logs [SERVER]               Show logs for specific server
    health                      Check health of all servers
    update                      Update all server repositories
    deploy                      Deploy using Docker Compose
    backup                      Backup configurations and data
    restore [BACKUP_FILE]       Restore from backup

Categories:
    development - Core development tools (GitHub, Docker, PostgreSQL, Postman, Azure DevOps)
    security    - Security and monitoring (JFrog, Cloudflare)
    business    - Business operations (Slack, Notion, Xero)
    realestate  - Real estate tools (RealEstateCRM, BatchData, Zillow)
    productivity - Productivity tools (Gmail, Calendar, File Management)
    all         - All servers

Examples:
    $0 start development        # Start all development servers
    $0 stop github             # Stop GitHub server
    $0 status all              # Show status of all servers
    $0 logs postgresql         # Show PostgreSQL server logs
    $0 health                  # Check health of all servers

EOF
}

# Get servers by category
get_servers_by_category() {
    local category="$1"
    local servers=()

    if [[ "$category" == "all" ]]; then
        for server in "${!SERVERS[@]}"; do
            servers+=("$server")
        done
    else
        for server in "${!SERVERS[@]}"; do
            if [[ "${SERVERS[$server]}" == "$category" ]]; then
                servers+=("$server")
            fi
        done
    fi

    echo "${servers[@]}"
}

# Check if server exists
server_exists() {
    local server="$1"
    [[ -n "${SERVERS[$server]:-}" ]]
}

# Check if category exists
category_exists() {
    local category="$1"
    local categories=("development" "security" "business" "realestate" "productivity" "all")
    for cat in "${categories[@]}"; do
        if [[ "$cat" == "$category" ]]; then
            return 0
        fi
    done
    return 1
}

# Service operations
start_server() {
    local server="$1"
    info "Starting MCP server: $server"

    if systemctl is-active --quiet "mcp-$server"; then
        warn "Server $server is already running"
        return 0
    fi

    if systemctl start "mcp-$server"; then
        log "Successfully started $server"
        sleep 2
        if systemctl is-active --quiet "mcp-$server"; then
            log "Server $server is now active"
        else
            error "Server $server failed to start properly"
            return 1
        fi
    else
        error "Failed to start $server"
        return 1
    fi
}

stop_server() {
    local server="$1"
    info "Stopping MCP server: $server"

    if ! systemctl is-active --quiet "mcp-$server"; then
        warn "Server $server is already stopped"
        return 0
    fi

    if systemctl stop "mcp-$server"; then
        log "Successfully stopped $server"
    else
        error "Failed to stop $server"
        return 1
    fi
}

restart_server() {
    local server="$1"
    info "Restarting MCP server: $server"

    if systemctl restart "mcp-$server"; then
        log "Successfully restarted $server"
        sleep 2
        if systemctl is-active --quiet "mcp-$server"; then
            log "Server $server is now active"
        else
            error "Server $server failed to restart properly"
            return 1
        fi
    else
        error "Failed to restart $server"
        return 1
    fi
}

show_status() {
    local server="$1"
    local status
    local port

    if systemctl is-active --quiet "mcp-$server"; then
        status="${GREEN}ACTIVE${NC}"
    else
        status="${RED}INACTIVE${NC}"
    fi

    # Get port from service file
    port=$(grep -oP 'MCP_SERVER_PORT=\K\d+' "$MCP_BASE_DIR/$server/.env" 2>/dev/null || echo "Unknown")

    printf "%-20s %-10s %-15s %-8s\n" "$server" "$status" "${SERVERS[$server]}" "$port"
}

show_logs() {
    local server="$1"
    info "Showing logs for MCP server: $server"

    if [[ -f "$MCP_LOG_DIR/$server.log" ]]; then
        tail -f "$MCP_LOG_DIR/$server.log"
    else
        journalctl -u "mcp-$server" -f
    fi
}

check_health() {
    info "Checking health of all MCP servers..."
    printf "\n%-20s %-10s %-15s %-10s %-15s\n" "SERVER" "STATUS" "CATEGORY" "PORT" "HEALTH"
    printf "%-20s %-10s %-15s %-10s %-15s\n" "$(printf '%.0s-' {1..20})" "$(printf '%.0s-' {1..10})" "$(printf '%.0s-' {1..15})" "$(printf '%.0s-' {1..10})" "$(printf '%.0s-' {1..15})"

    for server in "${!SERVERS[@]}"; do
        local status
        local health="Unknown"
        local port

        if systemctl is-active --quiet "mcp-$server"; then
            status="${GREEN}ACTIVE${NC}"
            port=$(grep -oP 'MCP_SERVER_PORT=\K\d+' "$MCP_BASE_DIR/$server/.env" 2>/dev/null || echo "Unknown")

            if [[ "$port" != "Unknown" ]]; then
                if curl -s -f "http://localhost:$port/health" >/dev/null 2>&1; then
                    health="${GREEN}HEALTHY${NC}"
                else
                    health="${YELLOW}UNHEALTHY${NC}"
                fi
            fi
        else
            status="${RED}INACTIVE${NC}"
            port="N/A"
            health="${RED}DOWN${NC}"
        fi

        printf "%-20s %-20s %-15s %-10s %-25s\n" "$server" "$status" "${SERVERS[$server]}" "$port" "$health"
    done

    echo ""
}

update_servers() {
    info "Updating all MCP server repositories..."

    for server in "${!SERVERS[@]}"; do
        if [[ -d "$MCP_BASE_DIR/$server" ]]; then
            info "Updating $server..."
            cd "$MCP_BASE_DIR/$server"
            if git pull origin main; then
                log "Successfully updated $server"
            else
                error "Failed to update $server"
            fi
        else
            warn "Repository for $server not found at $MCP_BASE_DIR/$server"
        fi
    done
}

deploy_docker() {
    info "Deploying MCP servers using Docker Compose..."

    cd "$MCP_BASE_DIR"
    if [[ -f "docker-compose.yml" ]]; then
        docker-compose down
        docker-compose pull
        docker-compose up -d
        log "Docker deployment completed"
    else
        error "docker-compose.yml not found in $MCP_BASE_DIR"
        return 1
    fi
}

backup_config() {
    local backup_dir="/tmp/mcp-backup-$(date +%Y%m%d-%H%M%S)"
    info "Creating backup at $backup_dir..."

    mkdir -p "$backup_dir"
    cp -r "$MCP_CONFIG_DIR" "$backup_dir/config"
    cp -r "$MCP_BASE_DIR/data" "$backup_dir/data" 2>/dev/null || true

    # Create backup info
    cat > "$backup_dir/backup-info.txt" << EOF
MCP Servers Backup
Created: $(date)
Config Directory: $MCP_CONFIG_DIR
Data Directory: $MCP_BASE_DIR/data
Servers: ${!SERVERS[@]}
EOF

    tar -czf "${backup_dir}.tar.gz" -C "$(dirname "$backup_dir")" "$(basename "$backup_dir")"
    rm -rf "$backup_dir"

    log "Backup created: ${backup_dir}.tar.gz"
}

# Main command handling
case "${1:-}" in
    start)
        target="${2:-all}"
        if server_exists "$target"; then
            start_server "$target"
